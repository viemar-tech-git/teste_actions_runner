name: Deploy PROD - Viemar Tech

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: [self-hosted, Linux, server-sql-pg-ubuntu]

    steps:
      - name: Checkout do código
        uses: actions/checkout@v4

      - name: Atualizar Servidor B (CentOS) via SSH
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: 10.0.1.215
          username: githubti
          key: ${{ secrets.ACTIONS_RUNNERS_SERVER_SQL_PG }}
          port: 22
          script: |
            echo "--- INICIANDO LIMPEZA E ATUALIZAÇÃO FORÇADA ---"
            cd /opt/teste_actions_runner
            
            # Configuração de segurança
            git config --global --add safe.directory /opt/teste_actions_runner
            
            # 1. Limpa qualquer tentativa de merge travada
            git merge --abort || true
            
            # 2. Busca tudo o que há de novo no GitHub
            git fetch --all
            
            # 3. FORÇA o servidor a ficar igual à branch main do GitHub
            # ATENÇÃO: Isso vai sobrescrever qualquer mudança feita direto no servidor
            git reset --hard origin/main
            
            # 4. Remove arquivos que não deveriam estar lá
            git clean -fd
            
            echo "--- VERIFICAÇÃO DO ARQUIVO TESTE.TXT ---"
            echo "Conteúdo atual:"
            cat teste.txt
            
            echo "--- INFO DO DEPLOY ---"
            echo "Hash do commit aplicado: $(git rev-parse --short HEAD)"
            echo "Data/Hora: $(date)"
            echo "--- SUCESSO ---"
