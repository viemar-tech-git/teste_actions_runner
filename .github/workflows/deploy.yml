name: Deploy PROD - Viemar Tech

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: [self-hosted, Linux, server-sql-pg-ubuntu]
    env:
      NOME_REPO: ${{ github.event.repository.name }}
    steps:
      - name: Checkout do código
        uses: actions/checkout@v4

      - name: Atualizar Servidor B (CentOS) via SSH
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: 10.0.1.215
          username: githubti
          key: ${{ secrets.ACTIONS_RUNNERS_SERVER_SQL_PG }}
          port: 22
          envs: NOME_REPO
          script: |
            TARGET_DIR="/opt/app_github/$NOME_REPO"
            REPO_SSH="git@github.com:viemar-tech-git/$NOME_REPO.git"

            echo "--- VERIFICANDO ESTRUTURA PARA O PROJETO: $NOME_REPO ---"

            # 1. Cria a pasta (precisa da Opção 1 acima configurada)
            if [ ! -d "$TARGET_DIR" ]; then
              echo "Diretório não existe. Criando $TARGET_DIR..."
              mkdir -p "$TARGET_DIR"
            fi

            # 2. Entra na pasta. Se falhar (por erro de permissão), o script para aqui.
            cd "$TARGET_DIR" || exit 1

            # 3. Se não houver .git, limpa a pasta (caso tenha lixo) e clona
            if [ ! -d ".git" ]; then
              echo "Iniciando repositório do zero..."
              # Garante que a pasta está vazia para o clone não dar erro
              rm -rf ..?* .[!.]* * 2>/dev/null || true
              git clone "$REPO_SSH" .
            else
              git remote set-url origin "$REPO_SSH"
            fi

            # 4. Configuração de segurança para o diretório
            git config --global --add safe.directory "$TARGET_DIR"
            
            echo "--- INICIANDO ATUALIZAÇÃO DO CÓDIGO ---"
            
            # 5. Limpa qualquer tentativa de merge travada
            git merge --abort || true
            
            # 6. Busca atualizações
            git fetch --all
            
            # 7. FORÇA o servidor a ficar igual à branch main
            git reset --hard origin/main
            
            # 8. Limpeza de arquivos não rastreados
            git clean -fd

            # 9. Garantir permissão de execução
            if [ -f "executar.sh" ]; then
              chmod +x executar.sh
            fi
            
            echo "--- INFO DO DEPLOY ---"
            echo "Projeto: $NOME_REPO"
            echo "Hash do commit aplicado: $(git rev-parse --short HEAD)"
            echo "Data/Hora: $(date)"
            echo "--- SUCESSO ---"
